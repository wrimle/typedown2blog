#!/usr/bin/env ruby

require 'fileutils'
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))
$LOAD_PATH.unshift(File.dirname(__FILE__))
require 'rubygems'
require 'typedown2blog'

include Typedown2Blog


begin
  require 'blog_config'
rescue MissingSourceFile => err
  puts "Put your settings in blog_config.rb"
  exit
end

puts Typedown2Blog::Blog.email
puts Typedown2Blog::Spec.glob

unless Typedown2Blog::Blog.email && Typedown2Blog::Spec.glob
  puts "#{__FILE__} blog_email incoming_mails_glob"
  puts "Or specify in blog_config.rb"
  exit
end


loop do
  # Read maildir and parse them if they are there
  didWork = false
  Dir.glob(Spec::glob) do |filename|
    Blog.post filename
    FileUtils::rm(filename)
    didWork = true
  end

  # If no mails where found, sleep a bit before looking again
  sleep(3) unless didWork
end
